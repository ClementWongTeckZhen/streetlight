<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Smart Street Light Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
    h2 { margin-top: 30px; }
    .status { display: flex; gap: 20px; margin: 10px 0; }
    .status-item { display: flex; align-items: center; gap: 6px; }
    .led { width: 14px; height: 14px; border-radius: 50%; background: gray; }
    .led.on { background: limegreen; }
    .led.off { background: red; }
    .controls { margin: 20px 0; }
    .controls label { display: block; margin: 10px 0 4px; }
    canvas { background: #fff; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Smart Street Light Dashboard</h1>

  <!-- 状态指示灯 -->
  <h2>状态</h2>
  <div class="status">
    <div class="status-item"><div id="emergency-led" class="led off"></div> Emergency</div>
    <div class="status-item"><div id="ir-led" class="led off"></div> IR Detect</div>
    <div class="status-item"><div id="fault-led" class="led off"></div> Lamp Fault</div>
  </div>

  <!-- 控制区 -->
  <h2>控制</h2>
  <div class="controls">
    <label><input type="checkbox" id="manualMode"> Manual Mode</label>
    <label>Brightness: <input type="range" id="brightness" min="0" max="255"></label>
    <label><input type="checkbox" id="autoEnvMode"> Auto Env Mode</label>
  </div>

  <!-- 图表 -->
  <h2>图表</h2>
  <canvas id="brightnessChart" height="100"></canvas>
  <canvas id="ldrChart" height="100"></canvas>
  <canvas id="currentChart" height="100"></canvas>

  <!-- 数据表 -->
  <h2>最新数据</h2>
  <table id="dataTable">
    <thead>
      <tr>
        <th>时间</th>
        <th>LDR</th>
        <th>亮度</th>
        <th>电流 (mA)</th>
        <th>Emergency</th>
        <th>IR</th>
        <th>Lamp Fault</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const firebaseUrl = "https://streetlight-6370e-default-rtdb.asia-southeast1.firebasedatabase.app/devices/smart-street-light";

// 状态灯更新
function updateLed(id, state) {
  const led = document.getElementById(id);
  led.className = "led " + (state ? "on" : "off");
}

// 图表初始化
function createChart(ctx, label, color) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{ label, data: [], borderColor: color, fill: false }]
    },
    options: {
      scales: { x: { display: false }, y: { beginAtZero: true } },
      responsive: true,
      animation: false
    }
  });
}

const brightnessChart = createChart(document.getElementById("brightnessChart"), "Brightness", "blue");
const ldrChart = createChart(document.getElementById("ldrChart"), "LDR", "orange");
const currentChart = createChart(document.getElementById("currentChart"), "Current (mA)", "green");

// 拉取最新数据
async function fetchLatest() {
  const res = await fetch(firebaseUrl + "/telemetry/latest.json");
  if (!res.ok) return;
  const data = await res.json();
  if (!data) return;

  const ts = new Date(data.timestamp * 1000).toLocaleTimeString();

  // 更新图表
  function pushData(chart, value) {
    chart.data.labels.push(ts);
    chart.data.datasets[0].data.push(value);
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }
  pushData(brightnessChart, data.brightness);
  pushData(ldrChart, data.ldr_value);
  pushData(currentChart, data.current_mA);

  // 更新状态灯
  updateLed("emergency-led", data.emergency);
  updateLed("ir-led", data.ir_left || data.ir_right);
  updateLed("fault-led", data.lamp_fault);

  // 更新表格
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = `
    <tr>
      <td>${ts}</td>
      <td>${data.ldr_value}</td>
      <td>${data.brightness}</td>
      <td>${data.current_mA.toFixed(2)}</td>
      <td>${data.emergency}</td>
      <td>${data.ir_left || data.ir_right}</td>
      <td>${data.lamp_fault}</td>
    </tr>
  `;
}

// 控制提交
async function updateControl(key, value) {
  await fetch(firebaseUrl + "/controls/" + key + ".json", {
    method: "PUT",
    body: JSON.stringify(value)
  });
}

// 控件监听
document.getElementById("manualMode").addEventListener("change", e => {
  updateControl("manual_mode", e.target.checked ? 1 : 0);
});
document.getElementById("autoEnvMode").addEventListener("change", e => {
  updateControl("auto_env_mode", e.target.checked ? 1 : 0);
});
document.getElementById("brightness").addEventListener("input", e => {
  updateControl("manual_brightness", parseInt(e.target.value));
});

// 定时刷新
setInterval(fetchLatest, 3000);
fetchLatest();
</script>
</body>
</html>
